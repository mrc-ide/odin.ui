## 'options' is a list containing the following names elements:

## - 'xy' is a matrix whose first column is always time, but with varying labels
## ('t' or 'step')

## - 'include' is a named logical vector indicating which variables should be
## - included in the plot, matched against the columns of xy[, -1]

## - 'cols' is a named vector of colors to be used for plotting the variables,
## matched against the columns of xy[, -1]

## - 'line_width' is a fixed line width

## - 'fill' is a logical (TRUE = region under lines is filled)

## - 'alpha' is the transparency used in the plot

## Note: we purposedly avoid the use of a piping operator here.

plot_model_output <- function(xy, options) {
  
  ## Generation of the basic plot
  include <- options$include
  var_to_keep <- names(include)[include]
  time <- round_time(xy[, 1, drop = TRUE])
  df <- cbind.data.frame(time = time,
                         xy[, var_to_keep, drop = FALSE])
  out <- dygraphs::dygraph(df)

  ## colors need to be unnamed; we also add transparency
  colors <- options$colors[var_to_keep]
  colors <- unname(transp(colors, options$alpha))
  
  ## Customisation of the plot
  out <- dygraphs::dyOptions(out,
                             colors = colors,
                             strokeWidth = options$line_width,
                             fillGraph = options$fill,
                             fillAlpha = max(0, options$alpha - 0.1),
                             labelsKMB = TRUE,
                             stackedGraph = options$stack,
                             digitsAfterDecimal = 0,
                             animatedZooms = TRUE)
  out <- dygraphs::dyAxis(out, "x", label = "Time", drawGrid = FALSE)
  out <- dygraphs::dyAxis(out, "y", label = NULL, drawGrid = FALSE)
  out <- dygraphs::dyRangeSelector(out, strokeColor = "#00000099",
                                   fillColor = "#0000004D",
                                   height = 0)

  out <- dygraphs::dyHighlight(out,
                               highlightSeriesOpts = list(strokeWidth = 2),
                               highlightCircleSize = 3,
                               highlightSeriesBackgroundAlpha = 1,
                               hideOnMouseOut = TRUE)

  out <- dygraphs::dyLegend(out, show = "follow",
                            showZeroValues = TRUE,
                            labelsSeparateLines = TRUE,
                            hideOnMouseOut = TRUE)
  out <- dygraphs::dyCSS(out, system.file("dygraphs.css", package = "odin.ui"))
  out
}
